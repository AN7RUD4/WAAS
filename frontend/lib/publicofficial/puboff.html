<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waste Management - Reporting Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Add SheetJS library for Excel generation -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: #f4f7f6;
            color: #2c3e50;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5em;
            font-weight: 300;
            border-bottom: 2px solid #3498db;
            padding-bottom: 15px;
        }

        .report-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .report-form {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .report-form input, 
        .report-form select, 
        .report-form button {
            padding: 10px;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .export-buttons {
            position: relative;
            display: inline-block;
        }

        .export-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: white;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 10;
            min-width: 150px;
        }

        .export-dropdown button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 10px;
            background: none;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .export-dropdown button:hover {
            background-color: #f4f6f7;
        }

        .export-dropdown button:disabled {
            color: #bdc3c7;
            cursor: not-allowed;
        }

        .export-trigger {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.3s ease;
        }

        .export-trigger:hover {
            background-color: #2980b9;
        }

        .export-trigger::after {
            content: 'â–¼';
            font-size: 0.7em;
            margin-left: 5px;
        }

        #reportResult {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 20px;
            margin-top: 20px;
        }

        .report-item {
            border-bottom: 1px solid #ecf0f1;
            padding: 15px 0;
        }

        .report-item:last-child {
            border-bottom: none;
        }

        .report-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .report-item-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .status-green { background-color: #2ecc71; color: white; }
        .status-yellow { background-color: #f39c12; color: white; }
        .status-orange { background-color: #e67e22; color: white; }
        .status-gray { background-color: #95a5a6; color: white; }

        .no-reports {
            text-align: center;
            color: #7f8c8d;
            padding: 20px;
        }

        #loader {
            text-align: center;
            padding: 20px;
            display: none;
        }

        .loading {
            color: #3498db;
            font-size: 1.2em;
        }

        @media (max-width: 768px) {
            .report-controls {
                flex-direction: column;
                gap: 15px;
            }

            .report-form {
                width: 100%;
                flex-direction: column;
            }

            .report-form input, 
            .report-form button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Waste Management Reporting Portal</h1>
        
        <div class="report-controls">
            <form id="reportForm" class="report-form">
                <input type="month" id="month" required>
                <input type="text" id="reportid" placeholder="Report ID (Optional)">
                <button type="submit">Generate Report</button>
            </form>
            <div class="export-buttons">
                <button class="export-trigger">Export</button>
                <div class="export-dropdown">
                    <button id="exportExcel">Excel (.xlsx)</button>
                    <button id="exportPDF" disabled>PDF (.pdf)</button>
                </div>
            </div>
        </div>

        <div id="loader" class="loading">
            Loading reports...
        </div>

        <div id="reportResult"></div>
    </div>

    <script>
        
const SUPABASE_URL = 'https://hrzroqrgkvzhomsosqzl.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhyenJvcXJna3Z6aG9tc29zcXpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE5MjQ0NDQsImV4cCI6MjA1NzUwMDQ0NH0.qBDNsN0DvMKZ8JBAmoh2DsN8WW74uj2hZZuG_-gxF4g';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const RENDER_URL = 'https://waas-9pr6.onrender.com';

        let currentReportData = [];

        document.addEventListener('DOMContentLoaded', () => {
            const reportForm = document.getElementById('reportForm');
            const reportResult = document.getElementById('reportResult');
            const loader = document.getElementById('loader');
            const exportExcel = document.getElementById('exportExcel');
            const exportPDF = document.getElementById('exportPDF');
            const exportTrigger = document.querySelector('.export-trigger');
            const exportDropdown = document.querySelector('.export-dropdown');

            // Dropdown toggle
            exportTrigger.addEventListener('click', () => {
                exportDropdown.style.display = 
                    exportDropdown.style.display === 'block' ? 'none' : 'block';
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (event) => {
                if (!exportTrigger.contains(event.target) && 
                    !exportDropdown.contains(event.target)) {
                    exportDropdown.style.display = 'none';
                }
            });

            reportForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const month = document.getElementById('month').value;
                const reportid = document.getElementById('reportid').value;
                
                loader.style.display = 'block';
                reportResult.innerHTML = '';
                exportExcel.disabled = true;
                exportPDF.disabled = true;

                try {
                    const [year, monthNum] = month.split('-').map(Number);
                    const startOfMonth = `${year}-${monthNum.toString().padStart(2, '0')}-01T00:00:00Z`;
                    const lastDay = new Date(year, monthNum, 0).getDate();
                    const endOfMonth = `${year}-${monthNum.toString().padStart(2, '0')}-${lastDay}T23:59:59Z`;

                    let query = supabaseClient
                        .from('garbagereports')
                        .select(`
                            reportid,
                            userid,
                            wastetype,
                            users!userid(name),
                            publicofficialapprovals!reportid (
                                workerid,
                                status,
                                comments,
                                datetime,
                                users!publicofficialapprovals_workerid_fkey(name)
                            )
                        `)
                        .gte('publicofficialapprovals.datetime', startOfMonth)
                        .lte('publicofficialapprovals.datetime', endOfMonth);

                    if (reportid) {
                        query = query.eq('reportid', reportid);
                    }

                    const { data: reportData, error: reportError } = await query;

                    if (reportError) throw reportError;

                    if (reportData.length === 0) {
                        resultDiv.innerHTML = `No reports found${reportid ? ` with ID ${reportid}` : ''} for the month of ${new Date(year, monthNum - 1).toLocaleString('default', { month: 'long', year: 'numeric' })}`;
                        return;
                    }

                    // Prepare data for Excel
                    const excelData = reportData.map(report => {
                        const approval = report.publicofficialapprovals[0] || {};
                        return {
                            'Report ID': report.reportid,
                            'Reported by': report.users.name || 'Unknown',
                            'Waste Type': report.wastetype || 'N/A',
                            'Attended By': approval.users?.name || 'Not Assigned',
                            'Status': approval.status || 'N/A',
                            'Comments': approval.comments || 'None',
                            'Date': approval.datetime ? new Date(approval.datetime).toLocaleString() : 'N/A'
                        };
                    });

                    // Create a new workbook and worksheet
                    const worksheet = XLSX.utils.json_to_sheet(excelData);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'Reports');

                    // Generate the Excel file and trigger download
                    const monthName = new Date(year, monthNum - 1).toLocaleString('default', { month: 'long', year: 'numeric' });
                    const fileName = `Reports_${monthName}${reportid ? `_ID_${reportid}` : ''}.xlsx`;
                    XLSX.writeFile(workbook, fileName);

                    // Display a message in the result div
                    resultDiv.innerHTML = `Report generated and downloaded as ${fileName}`;
                } catch (error) {
                    loader.style.display = 'none';
                    reportResult.innerHTML = `<div class="no-reports">Error generating report: ${error.message}</div>`;
                }
            });

            exportExcel.addEventListener('click', () => {
                if (currentReportData.length === 0) return;

                const exportData = currentReportData.map(report => {
                    const approval = report.publicofficialapprovals[0] || {};
                    return {
                        'Report ID': report.reportid,
                        'Reported By': report.users.name || 'Unknown',
                        'Waste Type': report.wastetype || 'N/A',
                        'Status': approval.status || 'N/A',
                        'Attended By': approval.users?.name || 'Not Assigned',
                        'Date': approval.datetime ? new Date(approval.datetime).toLocaleString() : 'N/A',
                        'Comments': approval.comments || 'None'
                    };
                });

                const worksheet = XLSX.utils.json_to_sheet(exportData);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Waste Reports');
                
                const monthName = document.getElementById('month').value;
                XLSX.writeFile(workbook, `Waste_Management_Report_${monthName}.xlsx`);
                exportDropdown.style.display = 'none';
            });
        });

        function getStatusColor(status) {
            switch(status) {
                case 'Completed': return 'status-green';
                case 'In Progress': return 'status-yellow';
                case 'Pending': return 'status-orange';
                default: return 'status-gray';
            }
        }
    </script>
</body>
</html>