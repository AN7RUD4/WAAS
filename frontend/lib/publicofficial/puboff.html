<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waste Management - Official Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Add SheetJS library for Excel generation -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }

        body {
            background-color: #f0f7f4;
            color: #2d5522;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px;
        }

        h1 {
            text-align: center;
            color: #2d5522;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        nav {
            margin-bottom: 30px;
            text-align: center;
            background-color: #4a8c3b;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        nav button {
            padding: 12px 25px;
            margin: 0 10px;
            cursor: pointer;
            background-color: #6bb356;
            border: none;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        nav button:hover {
            background-color: #559944;
        }

        .section {
            display: none;
            padding: 25px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .section.active {
            display: block;
        }

        h2 {
            color: #4a8c3b;
            margin-bottom: 20px;
        }

        h3 {
            color: #6bb356;
            margin-bottom: 15px;
        }

        form {
            display: grid;
            gap: 15px;
            max-width: 500px;
            background-color: #f0f7f4;
            padding: 20px;
            border-radius: 8px;
        }

        label {
            font-weight: bold;
        }

        input, select, button {
            padding: 12px;
            border: 1px solid #a8d39c;
            border-radius: 5px;
            background-color: white;
            font-size: 1em;
        }

        button {
            background-color: #6bb356;
            color: white;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #559944;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e6f0e5;
        }

        th {
            background-color: #4a8c3b;
            color: white;
        }

        tr:nth-child(even) {
            background-color: #f8faf7;
        }

        tr:hover {
            background-color: #e6f0e5;
        }

        .worker-form {
            margin-bottom: 40px;
        }

        #reportResult {
            margin-top: 20px;
            padding: 15px;
            background-color: #f0f7f4;
            border-radius: 5px;
            border-left: 4px solid #6bb356;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Waste Management Official Portal</h1>
        
        <nav>
            <button onclick="showSection('report')">Reports</button>
            <button onclick="showSection('workers')">Workers</button>
        </nav>

        <section id="report" class="section">
            <h2>Generate Report</h2>
            <form id="reportForm">
                <label for="month">Month:</label>
                <input type="month" id="month" required>
                <label for="reportid">Report ID (Optional):</label>
                <input type="number" id="reportid" placeholder="Enter Report ID">
                <button type="submit">Generate Report</button>
            </form>
            <div id="reportResult"></div>
        </section>

        <section id="workers" class="section">
            <h2>Worker Management</h2>
            <div class="worker-form">
                <h3>Add New Worker</h3>
                <form id="workerForm">
                    <label for="workerName">Worker Name:</label>
                    <input type="text" id="workerName" placeholder="Enter name" required>
                    <label for="workerId">Worker ID:</label>
                    <input type="number" id="workerId" placeholder="Enter ID" required>
                    <label for="workerEmail">Worker Email:</label>
                    <input type="email" id="workerEmail" placeholder="Enter email" required>
                    <label for="workerPhone">Worker Phone:</label>
                    <input type="tel" id="workerPhone" placeholder="Enter phone" required>
                    <label for="workerAddress">Worker Address:</label>
                    <input type="text" id="workerAddress" placeholder="Enter address" required>
                    <button type="submit">Add Worker</button>
                </form>
            </div>

            <div class="worker-list">
                <h3>Worker List</h3>
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="workerTableBody"></tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        const SUPABASE_URL = 'https://hrzroqrgkvzhomsosqzl.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhyenJvcXJna3Z6aG9tc29zcXpsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE5MjQ0NDQsImV4cCI6MjA1NzUwMDQ0NH0.qBDNsN0DvMKZ8JBAmoh2DsN8WW74uj2hZZuG_-gxF4g';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const RENDER_URL = 'https://waas-9pr6.onrender.com';

        document.addEventListener('DOMContentLoaded', async () => {
            showSection('report');
            await fetchWorkers();

            // Generate Report Form Submission
            const reportForm = document.getElementById('reportForm');
            reportForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const month = document.getElementById('month').value;
                const reportid = document.getElementById('reportid').value;
                const resultDiv = document.getElementById('reportResult');
                
                try {
                    // Calculate the start and end of the month
                    const [year, monthNum] = month.split('-').map(Number);
                    const startOfMonth = `${year}-${monthNum.toString().padStart(2, '0')}-01T00:00:00Z`;
                    const lastDay = new Date(year, monthNum, 0).getDate();
                    const endOfMonth = `${year}-${monthNum.toString().padStart(2, '0')}-${lastDay}T23:59:59Z`;

                    // First fetch all garbagereports for the month (or specific report if ID provided)
                    let reportQuery = supabaseClient
                        .from('garbagereports')
                        .select(`
                            reportid,
                            userid,
                            wastetype,
                            comments,
                            datetime,
                            users!garbagereports_userid_fkey(name)
                        `)
                        .gte('datetime', startOfMonth)
                        .lte('datetime', endOfMonth);

                    if (reportid) {
                        reportQuery = reportQuery.eq('reportid', parseInt(reportid));
                    }

                    const { data: reportData, error: reportError } = await reportQuery;
                    if (reportError) throw reportError;

                    // If no reports found, show message
                    if (!reportData || reportData.length === 0) {
                        resultDiv.innerHTML = `No reports found${reportid ? ` with ID ${reportid}` : ''} for the month of ${new Date(year, monthNum - 1).toLocaleString('default', { month: 'long', year: 'numeric' })}`;
                        return;
                    }

                    // Fetch all taskrequests
                    const { data: allTasks, error: taskError } = await supabaseClient
                        .from('taskrequests')
                        .select(`
                            taskid,
                            reportids,
                            assignedworkerid,
                            status,
                            users!taskrequests_assignedworkerid_fkey(name)
                        `);

                    if (taskError) throw taskError;

                    // Process reports and tasks
                    const combinedData = [];

                    // First handle reports that have tasks assigned
                    allTasks.forEach(task => {
                        // Ensure reportids is an array (handle both string and array formats)
                        const taskReportIds = Array.isArray(task.reportids) 
                            ? task.reportids.map(id => parseInt(id))
                            : [parseInt(task.reportids)];

                        taskReportIds.forEach(reportId => {
                            const matchingReport = reportData.find(r => parseInt(r.reportid) === reportId);
                            if (matchingReport) {
                                combinedData.push({
                                    taskid: task.taskid,
                                    reportid: matchingReport.reportid,
                                    reportedBy: matchingReport.users?.name || 'Unknown',
                                    wastetype: matchingReport.wastetype || 'Not specified',
                                    comments: matchingReport.comments || 'None',
                                    reportDate: matchingReport.datetime ? new Date(matchingReport.datetime).toLocaleString() : 'N/A',
                                    assignedWorkerName: task.users?.name || 'Not assigned',
                                    status: task.status || 'Unknown'
                                });
                            }
                        });
                    });

                    // Then handle reports that don't have any tasks assigned
                    reportData.forEach(report => {
                        const hasTask = allTasks.some(task => {
                            const taskReportIds = Array.isArray(task.reportids) 
                                ? task.reportids.map(id => parseInt(id))
                                : [parseInt(task.reportids)];
                            return taskReportIds.includes(parseInt(report.reportid));
                        });

                        if (!hasTask) {
                            combinedData.push({
                                reportid: report.reportid,
                                reportedBy: report.users?.name || 'Unknown',
                                wastetype: report.wastetype || 'Not specified',
                                comments: report.comments || 'None',
                                reportDate: report.datetime ? new Date(report.datetime).toLocaleString() : 'N/A',
                                status: 'Not assigned',
                                assignedWorkerName: 'Not assigned'
                            });
                        }
                    });

                    // Sort by report date
                    combinedData.sort((a, b) => {
                        const dateA = new Date(a.reportDate);
                        const dateB = new Date(b.reportDate);
                        return dateA - dateB;
                    });

                    // Display the combined data on the screen
                    resultDiv.innerHTML = combinedData.map(entry => `
                        <div>
                            ${entry.taskid ? `<strong>Task ID:</strong> ${entry.taskid}<br>` : ''}
                            <strong>Report ID:</strong> ${entry.reportid}<br>
                            <strong>Reported by:</strong> ${entry.reportedBy}<br>
                            <strong>Waste Type:</strong> ${entry.wastetype}<br>
                            <strong>Attended By:</strong> ${entry.assignedWorkerName}<br>
                            <strong>Status:</strong> ${entry.status}<br>
                            <strong>Comments:</strong> ${entry.comments}<br>
                            <strong>Report Date:</strong> ${entry.reportDate}<br>
                        </div><hr>
                    `).join('');

                    // Prepare data for Excel
                    const excelData = combinedData.map(entry => ({
                        'Task ID': entry.taskid || 'N/A',
                        'Report ID': entry.reportid,
                        'Reported by': entry.reportedBy,
                        'Waste Type': entry.wastetype,
                        'Attended By': entry.assignedWorkerName,
                        'Status': entry.status,
                        'Comments': entry.comments,
                        'Report Date': entry.reportDate
                    }));

                    // Create a new workbook and worksheet
                    const worksheet = XLSX.utils.json_to_sheet(excelData);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, 'Reports');

                    // Generate the Excel file and trigger download
                    const monthName = new Date(year, monthNum - 1).toLocaleString('default', { month: 'long', year: 'numeric' });
                    const fileName = `Reports_${monthName}${reportid ? `_ID_${reportid}` : ''}.xlsx`;
                    XLSX.writeFile(workbook, fileName);

                    // Append a message about the download to the result div
                    resultDiv.innerHTML += `<p>Report generated and downloaded as ${fileName}</p>`;
                } catch (error) {
                    resultDiv.innerHTML = `Error generating report: ${error.message}`;
                }
            });

            // Add Worker Form Submission
            const workerForm = document.getElementById('workerForm');
            workerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Generate a random 3-digit number for the password
                const randomNum = Math.floor(100 + Math.random() * 900); // Generates number between 100-999
                const generatedPassword = `Wor${randomNum}`;
                
                const worker = {
                    userid: parseInt(document.getElementById('workerId').value),
                    name: document.getElementById('workerName').value,
                    email: document.getElementById('workerEmail').value,
                    phone: document.getElementById('workerPhone').value,
                    address: document.getElementById('workerAddress').value,
                    password: generatedPassword, // Add the generated password
                    role: 'worker',
                    status: 'available'
                };

                try {
                    const { error } = await supabaseClient
                        .from('users')
                        .insert([worker]);
                    
                    if (error) throw error;
                    
                    // Show success message with the generated password
                    alert(`Worker added successfully!\nGenerated password: ${generatedPassword}`);
                    
                    workerForm.reset();
                    await fetchWorkers();
                } catch (error) {
                    alert(`Error adding worker: ${error.message}`);
                }
            });
        });

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
        }

        async function fetchWorkers() {
            try {
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*, taskrequests!taskrequests_assignedworkerid_fkey(status)')
                    .eq('role', 'worker');
                
                if (error) throw error;
                updateWorkerTable(data);
            } catch (error) {
                alert(`Error fetching workers: ${error.message}`);
            }
        }

        function updateWorkerTable(workers) {
        const tbody = document.getElementById('workerTableBody');
        tbody.innerHTML = '';
        
        workers.forEach((worker) => {
            const taskStatus = worker.taskrequests && worker.taskrequests.length > 0 
                ? worker.taskrequests[0].status 
                : 'Not Collecting';
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${worker.userid}</td>
                <td>${worker.name}</td>
                <td>${worker.email}</td>
                <td>${taskStatus}</td>
            `;
            tbody.appendChild(row);
        });
    }

        async function toggleStatus(workerId, currentStatus) {
            const newStatus = currentStatus === 'Collecting' ? 'Not Collecting' : 'Collecting';
            try {
                const { data: existingTasks, error: fetchError } = await supabaseClient
                    .from('taskrequests')
                    .select('reportids')
                    .eq('assignedworkerid', parseInt(workerId))
                    .eq('status', 'Collecting');
                
                if (fetchError) throw fetchError;

                if (existingTasks.length > 0) {
                    // Call backend to complete collection using RENDER_URL
                    const response = await fetch(`${RENDER_URL}/complete-collection`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            groupid: existingTasks[0].reportids, 
                            workerid: parseInt(workerId) 
                        })
                    });

                    if (!response.ok) {
                        const data = await response.json();
                        throw new Error(data.error);
                    }

                    const { error } = await supabaseClient
                        .from('taskrequests')
                        .update({
                            status: newStatus,
                            endtime: newStatus === 'Not Collecting' ? new Date().toISOString() : null
                        })
                        .eq('assignedworkerid', parseInt(workerId))
                        .eq('status', 'Collecting');
                    
                    if (error) throw error;
                } else if (newStatus === 'Collecting') {
                    const { error } = await supabaseClient
                        .from('taskrequests')
                        .insert([{
                            taskid: parseInt(Math.random() * 1000), // Generate a random taskid
                            reportids: parseInt(Math.random() * 100), // Generate a random reportids
                            assignedworkerid: parseInt(workerId),
                            status: newStatus,
                            starttime: new Date().toISOString()
                        }]);
                    
                    if (error) throw error;
                }

                await fetchWorkers();
            } catch (error) {
                alert(`Error updating status: ${error.message}`);
            }
        }
    </script>
</body>
</html>